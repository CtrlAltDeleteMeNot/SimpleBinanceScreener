<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScreenR</title>
  <link rel="stylesheet" href="css/pico.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/binance_api.js"></script>
  <script src="js/constants.js"></script>
</head>

<body>
  <header class="is-fixed-above-lg is-fixed fixed-header no-padding-bottom">
    <nav style="flex-direction: column;">
      <div class="header-row">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M9.41185 21.6588C9.94114 21.8006 10.4719 21.8972 11 21.9509C15.7947 22.4387 20.3717 19.3931 21.6593 14.5877C23.0887 9.25308 19.9229 3.76971 14.5882 2.34029C11.9556 1.63489 9.28684 2.04857 7.0869 3.28972M12 11.9996L5.00197 6.33546C4.57285 5.98813 3.93869 6.05182 3.63599 6.5135C3.06678 7.38163 2.62413 8.35389 2.34078 9.41136C1.37322 13.0224 2.51113 16.7015 5.00197 19.1453M7.36918 8.18416C6.51383 9.22115 6.00004 10.5503 6.00004 11.9996C6.00004 15.3133 8.68633 17.9996 12 17.9996C15.3137 17.9996 18 15.3133 18 11.9996C18 11.4818 17.9345 10.9793 17.8111 10.5M10.1029 6.30568C10.6991 6.10709 11.337 5.99955 12 5.99955C13.0929 5.99955 14.1175 6.29173 15 6.80222"
              stroke="red" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </div>
        <h1 class="no-margin-bottom" onclick="openInfoDialog()">ScreenR</h1>
      </div>
      <div role="group">
        <select id="filter-dropdown" class="filter-dropdown"></select>
        <button id="refresh-button" class="refresh-button" onclick="refresh()">Refresh</button>
      </div>
    </nav>
  </header>
  <main class="container">

    <dialog id="info-dialog">
      <article>
        <p>ScreenR is the ultimate companion for crypto traders focused on USDC pairs. Stay ahead of the market and make
          confident, informed trades with ScreenR by your side.</p>
        <p>Contact me for a tailored solution or see my code:</p>
        <ul>
          <li><a href="https://www.linkedin.com/in/gabriel-apostol/" target="_blank"
              rel="noopener noreferrer">LinkedIn</a></li>
          <li><a href="https://github.com/CtrlAltDeleteMeNot/SimpleBinanceScreener" target="_blank" rel="noopener noreferrer">GitHub code</a></li>
        </ul>
        <footer>
          <button class="secondary" onclick="closeInfoDialog()">Close</button>
        </footer>
      </article>
    </dialog>


    <div id="screener-grid-results" class="grid screener-results">
      <!-- Data will be dynamically inserted here -->

      <div style="display: none;">
        <article class="card">
          <div class="card-row">
            <img src="img/btcxxx.svg" onerror="useFallbackIcon(this)" class="crypto-icon"></img>
            <div class="card-info">
              <h3 class="base-asset">Bitcoin (BTC)</h3>
              <div class="base-asset-details">
                <p class="base-asset-details-price">$25,000</p>
                <p class="base-asset-details-percent-change">+3%</p>
              </div>
            </div>
            <button class="outline contrast">&rarr;</button>
          </div>
        </article>
      </div>

    </div>

  </main>



  <script>
    if (typeof (Worker) === "undefined") {
      console.log("No web worker support.");

    } else {
      worker = new Worker("js/worker.js");
      worker.onmessage = function (event) {
        populateUi(event.data);
        unlockUi();
      };
    }



    function initUi() {
      const filterDropdown = document.getElementById('filter-dropdown');
      var knownFilters = Filter.KnownFilters();
      knownFilters.forEach(element => {
        filterDropdown.innerHTML += `<option value="${element.idx}">${element.name}</option>`
      });
    }

    function clearUi(data) {
      const screenerResults = document.getElementById('screener-grid-results');
      screenerResults.innerHTML = '';
    }

    function populateUi(data) {
      if (data.success === true) {
        const screenerResults = document.getElementById('screener-grid-results');
        for (const item of data.data) {
          const div = document.createElement('div');
          const signum = item.changePercent > 0 ? "&#x25B2;" : "&#x25BC;";
          const colorClass = item.changePercent > 0 ? "color-percent-change-up" : "color-percent-change-down";
          div.innerHTML =
            `
            <article class="card">
            <div class="card-row">
              <img src="img/coins/${item.name.toLowerCase()}.svg" onerror="useFallbackIcon(this)" class="crypto-icon"></img>
              <div class="card-info">
                <h4 class="base-asset">${item.name}</h4>
                 <div class="base-asset-details">
                  <p class="no-margin-bottom">${item.close}</p>
                  <p class="no-margin-bottom ${colorClass}">${signum}${item.changePercent} %</p>
                </div>
              </div>
              <button class="outline contrast" onclick="window.open('https://www.tradingview.com/symbols/${item.name}USDC/?exchange=BINANCE')">&rarr;</button>
            </div>
          </article>
            `;
          screenerResults.appendChild(div);
        }
      } else {
        alert(data.data);
      }
    }


    function lockUi() {
      const refreshButton = document.getElementById('refresh-button');
      refreshButton.disabled = true; // Disable the button
      refreshButton.textContent = 'Refreshing...'; // Update button text
      const filterDropdown = document.getElementById('filter-dropdown');
      filterDropdown.disabled = true; // Disable the button
    }

    function unlockUi() {
      const refreshButton = document.getElementById('refresh-button');
      refreshButton.disabled = false; // Re-enable the button
      refreshButton.textContent = 'Refresh'; // Restore button text
      const filterDropdown = document.getElementById('filter-dropdown');
      filterDropdown.disabled = false; // Re-enable the button
    }

    function refresh() {
      clearUi();
      lockUi();
      const filterDropdown = document.getElementById('filter-dropdown');
      const filterIdx = filterDropdown.value;
      const filter = Filter.FindByIdx(filterIdx);
      worker.postMessage({ fetchThenApplyFilter: filter });
    }

    function useFallbackIcon(e) {
      e.src = "img/coins/fallback.svg";
    }

    function openInfoDialog() {
      const dialog = document.getElementById("info-dialog");
      dialog.showModal();
    }

    function closeInfoDialog() {
      const dialog = document.getElementById("info-dialog");
      dialog.close();
    }


    initUi();
    refresh();
  </script>
</body>

</html>